<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Message Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&family=Dancing+Script:wght@700&family=Share+Tech+Mono&family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        threat: ['Share Tech Mono', 'monospace'],
                        hand: ['Patrick Hand', 'cursive'],
                    },
                    colors: {
                        slate: { 850: '#151f32', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .hidden { display: none !important; }
        
        /* === THEMES === */
        
        /* 1. THREAT THEME */
        .theme-threat { font-family: 'Share Tech Mono', monospace; background: #000; color: #ff0000; }
        .theme-threat .glitch-effect { animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; }
        
        /* 2. LOVE LETTER THEME (ROSIE) */
        .theme-proposal {
            font-family: 'Patrick Hand', cursive;
            background-color: #fff0f5;
            background-image: 
                radial-gradient(at 10% 10%, rgba(255, 182, 193, 0.5) 0px, transparent 50%),
                radial-gradient(at 90% 90%, rgba(255, 228, 225, 0.8) 0px, transparent 50%);
            color: #5a3e46;
        }

        /* ENVELOPE & PAPER STYLES */
        .envelope-container { perspective: 1000px; width: 100%; max-width: 350px; margin: 0 auto; position: relative; z-index: 20; }
        .envelope {
            position: relative;
            background: #ff8fa3;
            height: 200px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .envelope:before { /* Left Fold */
            content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 0;
            border-style: solid; border-width: 100px 0 100px 175px;
            border-color: transparent transparent transparent #ff758f;
            border-radius: 0 0 0 10px;
        }
        .envelope:after { /* Right Fold */
            content: ''; position: absolute; bottom: 0; right: 0; width: 0; height: 0;
            border-style: solid; border-width: 100px 175px 100px 0;
            border-color: transparent #ff758f transparent transparent;
            border-radius: 0 0 10px 0;
        }
        .envelope-flap {
            position: absolute; top: 0; left: 0; width: 100%; height: 0;
            border-style: solid; border-width: 120px 175px 0 175px;
            border-color: #ff5c7c transparent transparent transparent;
            z-index: 30; transform-origin: top; transition: transform 0.6s ease;
        }
        .envelope.open .envelope-flap { transform: rotateX(180deg); z-index: 10; }
        
        .letter-paper {
            position: absolute;
            bottom: 0; left: 50%; transform: translateX(-50%);
            width: 90%; height: 250px;
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            transition: bottom 1s ease 0.5s;
            z-index: 15;
            display: flex; flex-direction: column;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
        }
        .envelope.open .letter-paper { bottom: 100px; height: 400px; }
        
        /* SCROLLING REELS TEXT */
        .reels-container {
            flex: 1;
            overflow-y: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .reel-line {
            opacity: 0.3; transform: scale(0.9); transition: all 0.5s ease;
            margin: 10px 0; text-align: center; font-size: 1.25rem; line-height: 1.5;
        }
        .reel-line.active { opacity: 1; transform: scale(1.1); color: #d63384; font-weight: bold; }
        
        /* GENERIC */
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .typing-cursor { border-right: 2px solid; animation: typeCursor 0.75s step-end infinite; }
        @keyframes typeCursor { 50% { border-color: transparent } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden flex selection:bg-indigo-100 selection:text-indigo-900">

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- === LOADER === -->
    <div id="init-loader" class="fixed inset-0 bg-white z-[90] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin"></div>
            <i class="fas fa-lock absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-slate-400"></i>
        </div>
        <p id="loader-text" class="mt-6 text-slate-500 font-mono text-sm tracking-widest animate-pulse">ESTABLISHING SECURE CONNECTION</p>
    </div>

    <!-- === VIEWER APP (PUBLIC) === -->
    <div id="viewer-app" class="hidden fixed inset-0 z-[80] flex flex-col items-center justify-center overflow-hidden">
        
        <!-- BG Layers -->
        <div id="viewer-bg-layer" class="absolute inset-0 bg-slate-900 z-0 transition-colors duration-1000"></div>
        <img id="viewer-bg-img" class="absolute inset-0 w-full h-full object-cover opacity-40 z-0 hidden">
        <video id="viewer-bg-video" class="absolute inset-0 w-full h-full object-cover z-0 hidden" loop muted playsinline></video>
        
        <!-- === UI LAYERS === -->
        <div class="relative z-10 w-full h-full overflow-y-auto flex flex-col items-center justify-center p-4">
            
            <!-- 1. THREAT UI -->
            <div id="ui-threat" class="hidden text-center max-w-2xl w-full">
                <div class="inline-block border-2 border-red-600 p-4 mb-6 glitch-effect bg-black/50 backdrop-blur-sm">
                    <h1 class="text-4xl md:text-6xl font-bold text-red-600 uppercase tracking-widest">WARNING</h1>
                </div>
                <div class="bg-black/90 border border-red-600/50 p-6 font-mono text-red-500 text-left mb-8 shadow-[0_0_20px_rgba(220,38,38,0.3)]">
                    <p class="text-xs text-red-800 mb-2 border-b border-red-900/50 pb-2 flex justify-between">
                        <span>/// CLASSIFIED ///</span>
                        <span id="threat-timer">00:00:00</span>
                    </p>
                    <p id="threat-text" class="text-lg md:text-xl leading-relaxed whitespace-pre-wrap typing-cursor"></p>
                </div>
                <div class="flex justify-center gap-4 text-xs font-mono text-red-900">
                    <p class="animate-pulse">IP LOGGED: <span id="viewer-ip">DETECTING...</span></p>
                    <p>SESSION: <span id="viewer-session">SECURE</span></p>
                </div>
            </div>

            <!-- 2. LOVE LETTER (ROSIE) UI -->
            <div id="ui-proposal" class="hidden w-full h-full flex flex-col items-center justify-center">
                <div class="envelope-container" id="love-envelope">
                    <div class="envelope">
                        <div class="envelope-flap"></div>
                        <div class="letter-paper">
                            <!-- Header -->
                            <div class="text-center mb-4 pb-2 border-b border-pink-100">
                                <i class="fas fa-heart text-pink-400 text-xl animate-pulse"></i>
                            </div>
                            <!-- Scrolling Text Area -->
                            <div id="reels-area" class="reels-container"></div>
                            <!-- Footer -->
                            <div class="text-center mt-4 pt-2 border-t border-pink-100 text-[10px] text-pink-300 uppercase tracking-widest">
                                Forever Yours
                            </div>
                        </div>
                    </div>
                </div>

                <!-- START BUTTON -->
                <button id="proposal-start-btn" class="mt-12 px-8 py-3 bg-white text-pink-500 rounded-full font-bold shadow-xl hover:scale-105 transition transform z-50 flex items-center gap-2">
                    <i class="fas fa-envelope-open-text"></i> Open Letter
                </button>
            </div>

            <!-- 3. STANDARD UI -->
            <div id="ui-standard" class="hidden max-w-2xl w-full bg-white p-8 shadow-2xl rounded-sm border-t-4 border-slate-800 relative">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white font-bold text-xs px-3 py-1 uppercase tracking-wider rounded">Confidential</div>
                <div class="border-b border-slate-100 pb-4 mb-4 flex justify-between items-end">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">Secure Document</h1>
                        <p class="text-slate-400 text-xs mt-1 font-mono">ID: <span id="doc-id">--</span></p>
                    </div>
                    <i class="fas fa-shield-alt text-4xl text-slate-100"></i>
                </div>
                <div class="prose prose-slate max-w-none">
                    <p id="standard-text" class="text-lg text-slate-700 whitespace-pre-wrap leading-relaxed"></p>
                </div>
                <div class="mt-8 pt-4 border-t border-slate-50 text-center">
                    <p class="text-xs text-slate-400">This message will self-destruct after viewing.</p>
                </div>
            </div>

            <!-- ERROR UI -->
            <div id="viewer-error" class="hidden text-center max-w-md bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl border border-red-100">
                <div class="text-6xl mb-6">ðŸš«</div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Access Denied</h2>
                <p id="error-msg" class="text-slate-600 mb-6">This message has self-destructed or does not exist.</p>
                <a href="/" class="inline-block px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium text-sm">Create New</a>
            </div>
        </div>
        
        <!-- AUDIO PLAYERS -->
        <audio id="bg-audio" class="hidden"></audio> 
        <div id="youtube-player" class="hidden"></div>
    </div>

    <!-- === DASHBOARD APP (ADMIN) === -->
    <div id="dashboard-app" class="hidden flex w-full h-full bg-slate-100">
        
        <!-- Sidebar -->
        <aside class="bg-slate-900 text-slate-400 w-20 lg:w-64 flex-shrink-0 flex flex-col transition-all duration-300">
            <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800 text-white font-bold tracking-tight">
                <i class="fas fa-user-secret text-indigo-500 text-xl lg:mr-2"></i>
                <span class="hidden lg:inline">Secure<span class="text-indigo-500">Platform</span></span>
            </div>
            
            <nav class="flex-1 p-2 lg:p-4 space-y-2 mt-4">
                <button onclick="renderDashboardHome()" class="nav-item w-full text-left px-3 py-3 lg:px-4 rounded-xl text-white bg-slate-800 flex items-center justify-center lg:justify-start group transition-colors">
                    <i class="fas fa-chart-line w-6 text-center group-hover:text-indigo-400"></i>
                    <span class="hidden lg:inline ml-3">Overview</span>
                </button>
                <button onclick="showCreateModal()" class="w-full text-left px-3 py-3 lg:px-4 rounded-xl hover:bg-slate-800/50 hover:text-white flex items-center justify-center lg:justify-start group transition-colors">
                    <i class="fas fa-plus-circle w-6 text-center group-hover:text-indigo-400"></i>
                    <span class="hidden lg:inline ml-3">New Secret</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center justify-center lg:justify-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-xs">
                        <span id="dash-avatar">A</span>
                    </div>
                    <div class="hidden lg:block overflow-hidden">
                        <p id="dash-username" class="text-sm text-white font-medium truncate">Admin</p>
                        <p class="text-xs text-slate-500">Logged In</p>
                    </div>
                    <button onclick="logout()" class="ml-auto text-slate-500 hover:text-red-400 lg:block hidden">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-hidden flex flex-col relative">
            <!-- Header -->
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8">
                <h2 class="text-xl font-bold text-slate-800">Mission Control</h2>
                <div class="flex items-center gap-4">
                     <button onclick="refreshDashboard()" class="p-2 text-slate-400 hover:text-indigo-600 transition" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 lg:p-8 space-y-8">
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Stat 1 -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Active Secrets</p>
                            <h3 id="stat-active" class="text-3xl font-bold text-slate-800">0</h3>
                        </div>
                        <div class="p-3 bg-green-50 text-green-600 rounded-lg">
                            <i class="fas fa-satellite-dish text-xl"></i>
                        </div>
                    </div>
                    <!-- Stat 2 -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Burned Archives</p>
                            <h3 id="stat-burned" class="text-3xl font-bold text-slate-800">0</h3>
                        </div>
                        <div class="p-3 bg-red-50 text-red-600 rounded-lg">
                            <i class="fas fa-fire text-xl"></i>
                        </div>
                    </div>
                    <!-- Stat 3 -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Intercepts</p>
                            <h3 id="stat-views" class="text-3xl font-bold text-slate-800">0</h3>
                        </div>
                        <div class="p-3 bg-indigo-50 text-indigo-600 rounded-lg">
                            <i class="fas fa-eye text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Secrets Table -->
                <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-bold text-slate-800">Recent Transmissions</h3>
                        <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded font-mono">LIVE FEED</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-600">
                            <thead class="bg-slate-50 text-slate-400 font-medium uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3">Type</th>
                                    <th class="px-6 py-3">ID / Content Preview</th>
                                    <th class="px-6 py-3 text-center">Views</th>
                                    <th class="px-6 py-3">Created</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="secrets-table-body" class="divide-y divide-slate-100">
                                <!-- JS Injection -->
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-state" class="hidden p-12 text-center">
                        <div class="inline-block p-4 rounded-full bg-slate-50 text-slate-300 mb-4">
                            <i class="fas fa-inbox text-4xl"></i>
                        </div>
                        <p class="text-slate-500">No transmissions found.</p>
                    </div>
                </div>
            </div>

            <!-- LOGS MODAL OVERLAY -->
            <div id="logs-modal" class="hidden absolute inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                        <h3 class="font-bold text-slate-800"><i class="fas fa-history text-indigo-500 mr-2"></i>Access Logs</h3>
                        <button onclick="closeLogs()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100 text-slate-500 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="px-6 py-3">Time</th>
                                    <th class="px-6 py-3">IP Address</th>
                                    <th class="px-6 py-3">Location</th>
                                    <th class="px-6 py-3">Device</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-slate-100 text-slate-700 font-mono text-xs">
                                <!-- Logs injected here -->
                            </tbody>
                        </table>
                        <div id="logs-empty" class="hidden p-8 text-center text-slate-400">
                            No access records found for this secret.
                        </div>
                    </div>
                </div>
            </div>

            <!-- CREATE MODAL OVERLAY -->
            <div id="create-modal" class="hidden absolute inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-bold text-slate-800">Create New Secret</h3>
                        <button onclick="closeCreateModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto">
                        <form id="create-form" class="space-y-6">
                            <!-- Type Selection -->
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Transmission Protocol</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <button type="button" onclick="setPreset('text')" class="preset-btn p-4 border-2 border-slate-100 rounded-xl hover:bg-slate-50 text-left transition relative overflow-hidden" data-preset="text">
                                        <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fas fa-file-alt text-4xl"></i></div>
                                        <div class="font-bold text-slate-800">Standard</div>
                                        <div class="text-xs text-slate-400 mt-1">Simple Text</div>
                                    </button>
                                    <button type="button" onclick="setPreset('threat')" class="preset-btn p-4 border-2 border-slate-100 rounded-xl hover:bg-red-50 hover:border-red-100 text-left transition relative overflow-hidden" data-preset="threat">
                                        <div class="absolute top-0 right-0 p-2 opacity-10 text-red-600"><i class="fas fa-biohazard text-4xl"></i></div>
                                        <div class="font-bold text-red-700">Threat</div>
                                        <div class="text-xs text-red-400 mt-1">Hacker Style</div>
                                    </button>
                                    <button type="button" onclick="setPreset('proposal')" class="preset-btn p-4 border-2 border-slate-100 rounded-xl hover:bg-pink-50 hover:border-pink-100 text-left transition relative overflow-hidden" data-preset="proposal">
                                        <div class="absolute top-0 right-0 p-2 opacity-10 text-pink-600"><i class="fas fa-heart text-4xl"></i></div>
                                        <div class="font-bold text-pink-600">Love Letter</div>
                                        <div class="text-xs text-pink-400 mt-1">Animated Envelope</div>
                                    </button>
                                </div>
                                <input type="hidden" id="secret-type" value="text">
                            </div>

                            <!-- Content -->
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Payload Content</label>
                                <textarea id="secret-content" rows="4" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition" placeholder="Enter confidential information..." required></textarea>
                            </div>

                            <!-- Audio Options -->
                            <div id="audio-options" class="hidden p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <label class="block font-bold mb-3 text-xs uppercase text-slate-500">Background Ambience</label>
                                <div class="flex gap-4 mb-4 text-sm">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="audio-source" value="youtube" checked onchange="toggleAudioSource()"> 
                                        <span><i class="fab fa-youtube text-red-500 mr-1"></i> YouTube</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="audio-source" value="file" onchange="toggleAudioSource()"> 
                                        <span><i class="fas fa-cloud-upload-alt text-indigo-500 mr-1"></i> Upload MP3</span>
                                    </label>
                                </div>
                                <div id="input-youtube">
                                    <input type="url" id="meta-youtube" class="w-full p-3 border rounded-lg text-sm" placeholder="https://youtube.com/watch?v=...">
                                </div>
                                <div id="input-file" class="hidden">
                                    <input type="file" id="file-upload" accept="audio/*,video/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                    <div id="upload-status" class="mt-2 text-xs text-slate-400 hidden">Uploading... <span id="upload-progress">0%</span></div>
                                    <input type="hidden" id="uploaded-url">
                                </div>
                            </div>

                            <!-- Advanced Settings -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Max Views</label>
                                    <input type="number" id="secret-views" value="1" min="1" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Self-Destruct Timer (Sec)</label>
                                    <input type="number" id="secret-timer" value="0" min="0" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg" placeholder="0 = Immediate">
                                </div>
                            </div>

                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                                Deploy Secret
                            </button>
                        </form>

                        <!-- Result -->
                        <div id="secret-result" class="hidden mt-6">
                            <div class="p-4 bg-green-50 border border-green-200 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="font-bold text-green-800 text-sm"><i class="fas fa-check-circle mr-2"></i>Secret Created Successfully</p>
                                    <button onclick="copyLink()" class="text-xs text-green-700 font-bold hover:underline">COPY</button>
                                </div>
                                <input type="text" id="result-link" readonly class="w-full p-2 bg-white border border-green-200 rounded text-sm text-slate-600 font-mono" onclick="this.select()">
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="resetCreateForm()" class="flex-1 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200">Create Another</button>
                                <button onclick="closeCreateModal()" class="flex-1 py-2 text-sm font-bold text-indigo-600 border border-indigo-100 rounded-lg hover:bg-indigo-50">Done</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- === AUTH (LOGIN) === -->
    <div id="auth-app" class="hidden fixed inset-0 z-[60] bg-slate-50 flex items-center justify-center">
        <div class="max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="inline-block p-4 rounded-full bg-slate-900 text-white mb-4 shadow-xl">
                    <i class="fas fa-fingerprint text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Admin Clearance</h2>
                <p class="text-slate-500 text-sm mt-1">Authenticate to access mission control.</p>
            </div>
            
            <form id="auth-form" class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                        <input type="text" id="auth-user" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Passcode</label>
                        <input type="password" id="auth-pass" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <button class="w-full py-3 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition transform active:scale-95">
                        Initialize Session
                    </button>
                </div>
                <div id="auth-error" class="hidden mt-4 text-center text-xs text-red-500 font-bold bg-red-50 p-2 rounded"></div>
            </form>
        </div>
    </div>

    <!-- === LOGIC === -->
    <script>
        // --- YOUTUBE API ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        var ytPlayer;
        function onYouTubeIframeAPIReady() {}

        // --- GLOBAL ---
        const API_URL = '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const secretId = urlParams.get('id');
        let token = localStorage.getItem('admin_token');

        // --- INIT ---
        window.onload = async () => {
            const loader = document.getElementById('init-loader');
            
            if (secretId) {
                // Viewer Mode
                await loadSecret(secretId);
                setTimeout(() => loader.classList.add('opacity-0', 'pointer-events-none'), 500);
                document.getElementById('viewer-app').classList.remove('hidden');
            } else {
                // Dashboard/Auth Mode
                if (token) {
                    await initDashboard();
                    setTimeout(() => loader.classList.add('opacity-0', 'pointer-events-none'), 500);
                    document.getElementById('dashboard-app').classList.remove('hidden');
                } else {
                    setTimeout(() => loader.classList.add('opacity-0', 'pointer-events-none'), 500);
                    document.getElementById('auth-app').classList.remove('hidden');
                }
            }
        };

        // --- AUTH ---
        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('auth-user').value;
            const p = document.getElementById('auth-pass').value;
            const btn = e.target.querySelector('button');
            const err = document.getElementById('auth-error');
            
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Verifying...';
            err.classList.add('hidden');

            try {
                const res = await fetch('/api/login', { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({username:u, password:p}) 
                });
                const d = await res.json();
                
                if(d.token) { 
                    localStorage.setItem('admin_token', d.token); 
                    location.reload(); 
                } else { 
                    throw new Error(d.error || 'Access Denied'); 
                }
            } catch (error) {
                btn.innerHTML = 'Initialize Session';
                err.innerText = error.message;
                err.classList.remove('hidden');
            }
        };

        function logout() {
            localStorage.removeItem('admin_token');
            location.reload();
        }

        // --- DASHBOARD LOGIC ---
        async function initDashboard() {
            await Promise.all([refreshStats(), refreshSecretsList()]);
            // Set initial preset UI
            setPreset('text'); 
        }

        async function refreshDashboard() {
            const icon = document.querySelector('.fa-sync-alt');
            icon.classList.add('fa-spin');
            await Promise.all([refreshStats(), refreshSecretsList()]);
            setTimeout(() => icon.classList.remove('fa-spin'), 500);
        }

        async function refreshStats() {
            try {
                const res = await fetch('/api/dashboard', { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.status === 401) { logout(); return; }
                const data = await res.json();
                
                // Update UI
                document.getElementById('dash-username').innerText = data.username || 'Admin';
                document.getElementById('dash-avatar').innerText = (data.username || 'A')[0].toUpperCase();
                
                animateValue('stat-active', parseInt(document.getElementById('stat-active').innerText), data.stats.active_secrets, 1000);
                animateValue('stat-burned', parseInt(document.getElementById('stat-burned').innerText), data.stats.burned_secrets, 1000);
                animateValue('stat-views', parseInt(document.getElementById('stat-views').innerText), data.stats.total_views, 1000);
            } catch(e) { console.error("Stats error", e); }
        }

        async function refreshSecretsList() {
            try {
                const res = await fetch('/api/secrets-list', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const tbody = document.getElementById('secrets-table-body');
                const empty = document.getElementById('empty-state');
                
                tbody.innerHTML = '';
                
                if(!data.secrets || data.secrets.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                empty.classList.add('hidden');

                data.secrets.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition group";
                    
                    // Status Logic
                    let statusHtml = s.is_active 
                        ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><span class="w-1.5 h-1.5 mr-1.5 bg-green-500 rounded-full"></span> Active</span>`
                        : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><span class="w-1.5 h-1.5 mr-1.5 bg-red-500 rounded-full"></span> Burned</span>`;
                    
                    // Date
                    const date = new Date(s.created_at * 1000).toLocaleDateString() + ' ' + new Date(s.created_at * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    // Icons based on type
                    let typeIcon = 'fa-file-alt';
                    if(s.type === 'threat') typeIcon = 'fa-user-secret';
                    if(s.type === 'proposal') typeIcon = 'fa-heart';

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${statusHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-500 capitalize"><i class="fas ${typeIcon} w-5 text-center mr-2 text-slate-400"></i>${s.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs text-slate-600">${s.id.substring(0, 18)}...</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-slate-700 font-bold">${s.view_count} <span class="text-slate-400 font-normal">/ ${s.max_views}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-slate-500">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="viewLogs('${s.id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 p-2 rounded transition" title="View Logs"><i class="fas fa-list-ul"></i></button>
                            <button onclick="copySecretLink('${s.id}')" class="text-slate-600 hover:text-slate-900 bg-slate-100 hover:bg-slate-200 p-2 rounded transition" title="Copy Link"><i class="fas fa-link"></i></button>
                            <button onclick="deleteSecret('${s.id}')" class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 p-2 rounded transition" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch(e) { console.error("List error", e); }
        }

        // --- ACTION MODALS ---

        // 1. LOGS
        async function viewLogs(id) {
            const modal = document.getElementById('logs-modal');
            const tbody = document.getElementById('logs-table-body');
            const empty = document.getElementById('logs-empty');
            
            modal.classList.remove('hidden');
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400"><i class="fas fa-circle-notch fa-spin mr-2"></i>Fetching Surveillance Data...</td></tr>';
            empty.classList.add('hidden');

            try {
                const res = await fetch(`/api/secret/logs/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                
                tbody.innerHTML = '';
                if(!data.logs || data.logs.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }

                data.logs.forEach(log => {
                    const date = new Date(log.viewed_at * 1000).toLocaleString();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-3 whitespace-nowrap">${date}</td>
                        <td class="px-6 py-3 text-indigo-600 font-bold">${log.ip_address || 'Unknown'}</td>
                        <td class="px-6 py-3 text-slate-600">${log.city || 'Unknown'}, ${log.country || 'Unknown'}</td>
                        <td class="px-6 py-3 text-slate-500">${log.device_type} / ${log.user_agent ? log.user_agent.substring(0, 20) + '...' : 'Unknown'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading logs: ${e.message}</td></tr>`;
            }
        }
        function closeLogs() { document.getElementById('logs-modal').classList.add('hidden'); }

        // 2. CREATE
        function showCreateModal() { document.getElementById('create-modal').classList.remove('hidden'); }
        function closeCreateModal() { 
            document.getElementById('create-modal').classList.add('hidden'); 
            resetCreateForm();
        }
        function resetCreateForm() {
            document.getElementById('create-form').reset();
            document.getElementById('create-form').classList.remove('hidden');
            document.getElementById('secret-result').classList.add('hidden');
            setPreset('text');
        }

        function setPreset(p) {
            // UI Update
            document.querySelectorAll('.preset-btn').forEach(b => {
                b.classList.remove('ring-2', 'ring-indigo-500', 'bg-slate-50', 'bg-red-50', 'bg-pink-50');
                b.classList.add('border-slate-100');
            });
            const active = document.querySelector(`button[data-preset="${p}"]`);
            active.classList.remove('border-slate-100');
            active.classList.add('ring-2', 'ring-indigo-500'); // Selection ring
            
            // Logic Update
            document.getElementById('secret-type').value = p;
            
            // Show Audio Options only for proposal
            if(p === 'proposal') document.getElementById('audio-options').classList.remove('hidden');
            else document.getElementById('audio-options').classList.add('hidden');
        }

        function toggleAudioSource() {
            const val = document.querySelector('input[name="audio-source"]:checked').value;
            document.getElementById('input-youtube').classList.toggle('hidden', val !== 'youtube');
            document.getElementById('input-file').classList.toggle('hidden', val !== 'file');
        }

        // Upload Logic
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            if(file.size > 15 * 1024 * 1024) { alert("File too large (Max 15MB)"); return; }
            
            const status = document.getElementById('upload-status');
            status.classList.remove('hidden');
            status.innerHTML = 'Encrypting & Uploading... <i class="fas fa-spinner fa-spin"></i>';

            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': file.type, 'X-File-Name': file.name },
                    body: file
                });
                const data = await res.json();
                if(data.url) {
                    document.getElementById('uploaded-url').value = data.url;
                    status.innerHTML = 'Upload Secure <i class="fas fa-check text-green-500"></i>';
                } else throw new Error("Upload failed");
            } catch(e) { status.innerText = "Error: " + e.message; }
        });

        // Submit Logic
        document.getElementById('create-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Encrypting...";
            btn.disabled = true;

            const type = document.getElementById('secret-type').value;
            const content = document.getElementById('secret-content').value;
            const views = document.getElementById('secret-views').value;
            const timer = document.getElementById('secret-timer').value;
            
            let audioUrl = '';
            let ytId = '';

            if (type === 'proposal') {
                const sourceType = document.querySelector('input[name="audio-source"]:checked').value;
                if (sourceType === 'youtube') {
                    const raw = document.getElementById('meta-youtube').value;
                    const match = raw.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
                    if (match) ytId = match[1];
                } else {
                    audioUrl = document.getElementById('uploaded-url').value;
                }
            }

            try {
                const res = await fetch('/api/secret', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        content, type, max_views: parseInt(views), expiry_seconds: parseInt(timer),
                        metadata: { youtubeId: ytId, audioUrl: audioUrl }
                    })
                });
                const data = await res.json();
                
                document.getElementById('result-link').value = `${location.origin}?id=${data.id}`;
                document.getElementById('create-form').classList.add('hidden');
                document.getElementById('secret-result').classList.remove('hidden');
                refreshDashboard(); // Update list
            } catch(e) { alert(e.message); }
            
            btn.innerText = originalText;
            btn.disabled = false;
        };

        // 3. DELETE
        async function deleteSecret(id) {
            if(!confirm("Are you sure? This will destroy all evidence and logs.")) return;
            try {
                await fetch(`/api/secret/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                refreshDashboard();
                showToast("Secret destroyed successfully.", "success");
            } catch(e) { alert(e.message); }
        }

        function copySecretLink(id) {
            const url = `${location.origin}?id=${id}`;
            navigator.clipboard.writeText(url);
            showToast("Secure link copied to clipboard.", "success");
        }
        
        function copyLink() {
            const copyText = document.getElementById("result-link");
            copyText.select();
            document.execCommand("copy");
            showToast("Link copied!", "success");
        }

        // --- UTILS ---
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-green-600' : 'bg-slate-800';
            toast.className = `${colorClass} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center gap-3`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : 'fa-info-circle'}"></i> <span>${msg}</span>`;
            
            container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // Remove
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- VIEWER LOGIC (Untouched mostly, just cleaner error handling) ---
        async function loadSecret(id) {
            try {
                const res = await fetch(`/api/secret/${id}`);
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                const meta = data.metadata || {};

                if (data.type === 'proposal') {
                    // LOVE LETTER THEME
                    document.body.className = "theme-proposal h-screen overflow-hidden"; 
                    document.getElementById('ui-proposal').classList.remove('hidden');
                    
                    if (meta.youtubeId) {
                        ytPlayer = new YT.Player('youtube-player', {
                            height: '0', width: '0', videoId: meta.youtubeId,
                            playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1 }
                        });
                    } else if (meta.audioUrl) {
                        const aud = document.getElementById('bg-audio');
                        aud.src = meta.audioUrl;
                        aud.loop = true;
                    }

                    const lines = data.content.split('\n').filter(l => l.trim() !== '');
                    const container = document.getElementById('reels-area');
                    lines.forEach((line, i) => {
                        const p = document.createElement('p');
                        p.className = `reel-line line-${i}`;
                        p.innerText = line;
                        container.appendChild(p);
                    });

                    const btn = document.getElementById('proposal-start-btn');
                    btn.onclick = () => {
                        document.querySelector('.envelope').classList.add('open');
                        btn.classList.add('hidden');
                        if(meta.youtubeId && ytPlayer && ytPlayer.playVideo) ytPlayer.playVideo();
                        else document.getElementById('bg-audio').play().catch(e=>console.log(e));

                        let activeIdx = 0;
                        const allLines = document.querySelectorAll('.reel-line');
                        if(allLines.length > 0) allLines[0].classList.add('active');
                        const interval = setInterval(() => {
                            if (activeIdx >= allLines.length) { clearInterval(interval); return; }
                            allLines.forEach(l => l.classList.remove('active'));
                            allLines[activeIdx].classList.add('active');
                            allLines[activeIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            activeIdx++;
                        }, 2500);
                    };

                } else if (data.type === 'threat') {
                    document.body.className = "bg-black h-screen overflow-hidden";
                    document.getElementById('ui-threat').classList.remove('hidden');
                    const textEl = document.getElementById('threat-text');
                    
                    // Typewriter effect
                    const text = data.content;
                    let i = 0;
                    const typeInterval = setInterval(() => {
                         textEl.textContent += text.charAt(i);
                         i++;
                         if(i > text.length) clearInterval(typeInterval);
                    }, 50);

                } else {
                    document.getElementById('ui-standard').classList.remove('hidden');
                    document.getElementById('standard-text').innerText = data.content;
                    document.getElementById('doc-id').innerText = id.substring(0,8).toUpperCase();
                }

            } catch(e) {
                document.getElementById('viewer-error').classList.remove('hidden');
                document.getElementById('error-msg').innerText = e.message;
            }
        }
    </script>
</body>
</html>

