<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Message Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&family=Dancing+Script:wght@700&family=Share+Tech+Mono&family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .hidden { display: none !important; }
        
        /* === THEMES === */
        
        /* 1. THREAT THEME */
        .theme-threat { font-family: 'Share Tech Mono', monospace; background: #000; color: #ff0000; }
        .theme-threat .glitch-effect { animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; }
        
        /* 2. LOVE LETTER THEME (ROSIE) */
        .theme-proposal {
            font-family: 'Patrick Hand', cursive; /* Cartoonish handwriting */
            background-color: #fff0f5; /* Lavender Blush */
            background-image: 
                radial-gradient(at 10% 10%, rgba(255, 182, 193, 0.5) 0px, transparent 50%),
                radial-gradient(at 90% 90%, rgba(255, 228, 225, 0.8) 0px, transparent 50%);
            color: #5a3e46;
        }

        /* ENVELOPE & PAPER STYLES */
        .envelope-container { perspective: 1000px; width: 100%; max-width: 350px; margin: 0 auto; position: relative; z-index: 20; }
        .envelope {
            position: relative;
            background: #ff8fa3;
            height: 200px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .envelope:before { /* Left Fold */
            content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 0;
            border-style: solid; border-width: 100px 0 100px 175px;
            border-color: transparent transparent transparent #ff758f;
            border-radius: 0 0 0 10px;
        }
        .envelope:after { /* Right Fold */
            content: ''; position: absolute; bottom: 0; right: 0; width: 0; height: 0;
            border-style: solid; border-width: 100px 175px 100px 0;
            border-color: transparent #ff758f transparent transparent;
            border-radius: 0 0 10px 0;
        }
        .envelope-flap {
            position: absolute; top: 0; left: 0; width: 100%; height: 0;
            border-style: solid; border-width: 120px 175px 0 175px;
            border-color: #ff5c7c transparent transparent transparent;
            z-index: 30; transform-origin: top; transition: transform 0.6s ease;
        }
        .envelope.open .envelope-flap { transform: rotateX(180deg); z-index: 10; }
        
        .letter-paper {
            position: absolute;
            bottom: 0; left: 50%; transform: translateX(-50%);
            width: 90%; height: 250px;
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            transition: bottom 1s ease 0.5s;
            z-index: 15;
            display: flex; flex-direction: column;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
        }
        .envelope.open .letter-paper { bottom: 100px; height: 400px; }
        
        /* SCROLLING REELS TEXT */
        .reels-container {
            flex: 1;
            overflow-y: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .reel-line {
            opacity: 0.3; transform: scale(0.9); transition: all 0.5s ease;
            margin: 10px 0; text-align: center; font-size: 1.25rem; line-height: 1.5;
        }
        .reel-line.active { opacity: 1; transform: scale(1.1); color: #d63384; font-weight: bold; }
        
        /* GENERIC */
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .typing-cursor { border-right: 2px solid; animation: typeCursor 0.75s step-end infinite; }
        @keyframes typeCursor { 50% { border-color: transparent } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden flex">

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- === LOADER === -->
    <div id="init-loader" class="fixed inset-0 bg-white z-[90] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-slate-900 border-t-transparent rounded-full animate-spin"></div>
        <p id="loader-text" class="mt-4 text-slate-500 font-mono tracking-widest text-xs">ESTABLISHING SECURE CONNECTION</p>
        <button onclick="location.reload()" id="retry-btn" class="hidden mt-4 text-indigo-600 text-sm font-bold underline">Retry Connection</button>
    </div>

    <!-- === VIEWER APP === -->
    <div id="viewer-app" class="hidden fixed inset-0 z-[80] flex flex-col items-center justify-center overflow-hidden">
        
        <!-- BG Layers -->
        <div id="viewer-bg-layer" class="absolute inset-0 bg-slate-900 z-0 transition-colors duration-1000"></div>
        <img id="viewer-bg-img" class="absolute inset-0 w-full h-full object-cover opacity-40 z-0 hidden">
        <video id="viewer-bg-video" class="absolute inset-0 w-full h-full object-cover z-0 hidden" loop muted playsinline></video>
        
        <!-- === UI LAYERS === -->
        <div class="relative z-10 w-full h-full overflow-y-auto flex flex-col items-center justify-center p-4">
            
            <!-- 1. THREAT UI -->
            <div id="ui-threat" class="hidden text-center max-w-2xl w-full">
                <div class="inline-block border-2 border-red-600 p-4 mb-6 glitch-effect">
                    <h1 class="text-6xl font-bold text-red-600 uppercase tracking-widest">WARNING</h1>
                </div>
                <div class="bg-black/80 border border-red-600/50 p-6 font-mono text-red-500 text-left mb-8">
                    <p class="text-xs text-red-800 mb-2">/// ENCRYPTED TRANSMISSION ///</p>
                    <p id="threat-text" class="text-xl leading-relaxed whitespace-pre-wrap typing-cursor"></p>
                </div>
                <p class="text-red-900 text-xs animate-pulse">IP LOGGED: <span id="viewer-ip">DETECTING...</span></p>
            </div>

            <!-- 2. LOVE LETTER (ROSIE) UI -->
            <div id="ui-proposal" class="hidden w-full h-full flex flex-col items-center justify-center">
                
                <div class="envelope-container" id="love-envelope">
                    <div class="envelope">
                        <div class="envelope-flap"></div>
                        <div class="letter-paper">
                            <!-- Header -->
                            <div class="text-center mb-4 pb-2 border-b border-pink-100">
                                <i class="fas fa-heart text-pink-400 text-xl animate-pulse"></i>
                            </div>
                            <!-- Scrolling Text Area -->
                            <div id="reels-area" class="reels-container">
                                <!-- Lines injected here -->
                            </div>
                            <!-- Footer -->
                            <div class="text-center mt-4 pt-2 border-t border-pink-100 text-[10px] text-pink-300 uppercase tracking-widest">
                                Forever Yours
                            </div>
                        </div>
                    </div>
                </div>

                <!-- START BUTTON (Overlays Envelope) -->
                <button id="proposal-start-btn" class="mt-12 px-8 py-3 bg-white text-pink-500 rounded-full font-bold shadow-xl hover:scale-105 transition transform z-50">
                    <i class="fas fa-envelope-open-text mr-2"></i> Open Letter
                </button>

            </div>

            <!-- 3. STANDARD UI -->
            <div id="ui-standard" class="hidden max-w-2xl w-full bg-white p-8 shadow-2xl rounded-sm border-t-4 border-yellow-500 relative">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black font-bold text-xs px-3 py-1 uppercase tracking-wider rounded">Confidential</div>
                <div class="border-b border-slate-100 pb-4 mb-4 flex justify-between items-end">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">Secure Document</h1>
                        <p class="text-slate-400 text-xs mt-1">ID: <span id="doc-id" class="font-mono">--</span></p>
                    </div>
                    <i class="fas fa-file-shield text-4xl text-slate-200"></i>
                </div>
                <div class="prose prose-slate">
                    <p id="standard-text" class="text-lg text-slate-700 whitespace-pre-wrap"></p>
                </div>
            </div>

            <!-- ERROR UI -->
            <div id="viewer-error" class="hidden text-center max-w-md bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl">
                <div class="text-6xl mb-4">ðŸš«</div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Access Denied</h2>
                <p id="error-msg" class="text-slate-600 mb-6">Message self-destructed.</p>
                <a href="/" class="text-indigo-600 hover:underline text-sm">Create New</a>
            </div>
        </div>
        
        <!-- AUDIO PLAYERS -->
        <audio id="bg-audio" class="hidden"></audio> <!-- File/MP3 -->
        <div id="youtube-player" class="hidden"></div> <!-- YouTube API -->
    </div>

    <!-- === DASHBOARD / CREATOR === -->
    <div id="dashboard-app" class="hidden flex w-full h-full bg-slate-50">
        <!-- Reusing previous dashboard structure, simplified for brevity in this update -->
        <aside class="bg-slate-900 text-slate-400 w-64 flex-shrink-0 flex flex-col">
            <div class="h-20 flex items-center px-6 border-b border-slate-800 text-white font-bold">Secure<span class="text-indigo-500">Platform</span></div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="location.reload()" class="w-full text-left px-4 py-3 hover:bg-slate-800 rounded text-white"><i class="fas fa-home mr-2"></i> Dashboard</button>
            </nav>
        </aside>
        
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-8">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Create New Message</h2>
                
                <form id="create-form" class="space-y-6">
                    <!-- Type Selection -->
                    <div class="grid grid-cols-3 gap-4">
                        <button type="button" onclick="setPreset('text')" class="preset-btn p-4 border rounded-xl hover:bg-slate-50" data-preset="text">Standard</button>
                        <button type="button" onclick="setPreset('threat')" class="preset-btn p-4 border rounded-xl hover:bg-slate-50 text-red-600" data-preset="threat">Threat</button>
                        <button type="button" onclick="setPreset('proposal')" class="preset-btn p-4 border border-indigo-500 bg-indigo-50 rounded-xl text-pink-600 font-bold" data-preset="proposal">Love Letter</button>
                    </div>
                    <input type="hidden" id="secret-type" value="proposal">

                    <!-- Content -->
                    <div>
                        <label class="block font-bold mb-2">Message Content</label>
                        <textarea id="secret-content" rows="6" class="w-full p-4 border rounded-xl" placeholder="Write your letter here... lines will scroll nicely." required></textarea>
                    </div>

                    <!-- Audio Options -->
                    <div id="audio-options" class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <label class="block font-bold mb-3 text-sm uppercase text-slate-500">Background Audio</label>
                        
                        <div class="flex gap-4 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="audio-source" value="youtube" checked onchange="toggleAudioSource()"> 
                                <i class="fab fa-youtube text-red-500"></i> YouTube Link
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="audio-source" value="file" onchange="toggleAudioSource()"> 
                                <i class="fas fa-file-audio text-indigo-500"></i> Upload File
                            </label>
                        </div>

                        <!-- YouTube Input -->
                        <div id="input-youtube">
                            <input type="url" id="meta-youtube" class="w-full p-3 border rounded-lg text-sm" placeholder="https://youtube.com/watch?v=...">
                        </div>

                        <!-- File Upload -->
                        <div id="input-file" class="hidden">
                            <input type="file" id="file-upload" accept="audio/*,video/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <div id="upload-status" class="mt-2 text-xs text-slate-400 hidden">Uploading... <span id="upload-progress">0%</span></div>
                            <input type="hidden" id="uploaded-url">
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block font-bold mb-2 text-xs uppercase">Views</label>
                            <input type="number" id="secret-views" value="1" class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block font-bold mb-2 text-xs uppercase">Timer (Sec)</label>
                            <input type="number" id="secret-timer" value="0" class="w-full p-3 border rounded-lg">
                        </div>
                    </div>

                    <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">Create Secret</button>
                </form>

                <!-- Result -->
                <div id="secret-result" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-xl">
                    <p class="font-bold text-green-800 mb-2">Secret Created!</p>
                    <input type="text" id="result-link" readonly class="w-full p-2 bg-white border rounded text-sm" onclick="this.select()">
                </div>
            </div>
        </main>
    </div>
    
    <!-- === AUTH (Simplified) === -->
    <div id="auth-app" class="hidden fixed inset-0 z-[60] bg-white flex items-center justify-center">
        <form id="auth-form" class="p-8 border rounded-xl shadow-xl w-80 text-center">
            <h2 class="text-xl font-bold mb-4">Admin Login</h2>
            <input type="text" id="auth-user" placeholder="User" class="w-full mb-3 p-2 border rounded">
            <input type="password" id="auth-pass" placeholder="Pass" class="w-full mb-4 p-2 border rounded">
            <button class="w-full bg-slate-900 text-white py-2 rounded">Login</button>
        </form>
    </div>

    <!-- === LOGIC === -->
    <script>
        // Load YouTube IFrame API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        var ytPlayer;
        function onYouTubeIframeAPIReady() { /* Ready */ }

        // --- APP LOGIC ---
        const API_URL = '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const secretId = urlParams.get('id');
        let token = localStorage.getItem('admin_token');

        // Init
        window.onload = async () => {
            if (secretId) {
                // Viewer
                await loadSecret(secretId);
                document.getElementById('init-loader').classList.add('hidden');
                document.getElementById('viewer-app').classList.remove('hidden');
            } else {
                // Admin
                if (token) {
                    document.getElementById('init-loader').classList.add('hidden');
                    document.getElementById('dashboard-app').classList.remove('hidden');
                } else {
                    document.getElementById('init-loader').classList.add('hidden');
                    document.getElementById('auth-app').classList.remove('hidden');
                }
            }
        };

        // --- CREATOR LOGIC ---
        function setPreset(p) {
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('border-indigo-500','bg-indigo-50'));
            document.querySelector(`button[data-preset="${p}"]`).classList.add('border-indigo-500','bg-indigo-50');
            document.getElementById('secret-type').value = p;
        }

        function toggleAudioSource() {
            const val = document.querySelector('input[name="audio-source"]:checked').value;
            document.getElementById('input-youtube').classList.toggle('hidden', val !== 'youtube');
            document.getElementById('input-file').classList.toggle('hidden', val !== 'file');
        }

        // File Upload Handler
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            // Limit size (e.g. 15MB)
            if(file.size > 15 * 1024 * 1024) { alert("File too large (Max 15MB)"); return; }

            const status = document.getElementById('upload-status');
            status.classList.remove('hidden');
            status.innerHTML = 'Uploading... <i class="fas fa-spinner fa-spin"></i>';

            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': file.type,
                        'X-File-Name': file.name
                    },
                    body: file
                });
                const data = await res.json();
                if(data.url) {
                    document.getElementById('uploaded-url').value = data.url;
                    status.innerHTML = 'Upload Complete <i class="fas fa-check text-green-500"></i>';
                } else { throw new Error("Upload failed"); }
            } catch(e) {
                status.innerText = "Error: " + e.message;
            }
        });

        document.getElementById('create-form').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('secret-type').value;
            const content = document.getElementById('secret-content').value;
            const views = document.getElementById('secret-views').value;
            const timer = document.getElementById('secret-timer').value;
            
            // Audio logic
            const sourceType = document.querySelector('input[name="audio-source"]:checked').value;
            let audioUrl = '';
            let ytId = '';

            if (sourceType === 'youtube') {
                const raw = document.getElementById('meta-youtube').value;
                const match = raw.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
                if (match) ytId = match[1];
            } else {
                audioUrl = document.getElementById('uploaded-url').value;
            }

            try {
                const res = await fetch('/api/secret', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        content, type, max_views: parseInt(views), expiry_seconds: parseInt(timer),
                        metadata: { youtubeId: ytId, audioUrl: audioUrl }
                    })
                });
                const data = await res.json();
                document.getElementById('result-link').value = `${location.origin}?id=${data.id}`;
                document.getElementById('secret-result').classList.remove('hidden');
            } catch(e) { alert(e.message); }
        };

        // --- AUTH ---
        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('auth-user').value;
            const p = document.getElementById('auth-pass').value;
            const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            const d = await res.json();
            if(d.token) { localStorage.setItem('admin_token', d.token); location.reload(); }
            else alert(d.error);
        };

        // --- VIEWER LOGIC ---
        async function loadSecret(id) {
            try {
                const res = await fetch(`/api/secret/${id}`);
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                const meta = data.metadata || {};

                // UI Selection
                if (data.type === 'proposal') {
                    // LOVE LETTER THEME
                    document.body.className = "theme-proposal h-screen overflow-hidden"; // Apply font/bg
                    document.getElementById('ui-proposal').classList.remove('hidden');
                    
                    // Setup Audio
                    if (meta.youtubeId) {
                        ytPlayer = new YT.Player('youtube-player', {
                            height: '0', width: '0',
                            videoId: meta.youtubeId,
                            playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1 }
                        });
                    } else if (meta.audioUrl) {
                        const aud = document.getElementById('bg-audio');
                        aud.src = meta.audioUrl;
                        aud.loop = true;
                    }

                    // Prepare Text for Reels Effect
                    const lines = data.content.split('\n').filter(l => l.trim() !== '');
                    const container = document.getElementById('reels-area');
                    lines.forEach((line, i) => {
                        const p = document.createElement('p');
                        p.className = `reel-line line-${i}`;
                        p.innerText = line;
                        container.appendChild(p);
                    });

                    // Start Button Interaction
                    const btn = document.getElementById('proposal-start-btn');
                    btn.onclick = () => {
                        // 1. Open Envelope
                        document.querySelector('.envelope').classList.add('open');
                        btn.classList.add('hidden'); // Hide button

                        // 2. Play Audio
                        if(meta.youtubeId && ytPlayer && ytPlayer.playVideo) ytPlayer.playVideo();
                        else document.getElementById('bg-audio').play().catch(e=>console.log(e));

                        // 3. Start Scrolling Animation
                        let activeIdx = 0;
                        const allLines = document.querySelectorAll('.reel-line');
                        
                        // Initial state
                        if(allLines.length > 0) allLines[0].classList.add('active');

                        const interval = setInterval(() => {
                            if (activeIdx >= allLines.length) {
                                clearInterval(interval);
                                return;
                            }

                            // Update classes
                            allLines.forEach(l => l.classList.remove('active'));
                            allLines[activeIdx].classList.add('active');
                            
                            // Scroll to center
                            allLines[activeIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            activeIdx++;
                        }, 2500); // 2.5 seconds per line (adjustable)
                    };

                } else if (data.type === 'threat') {
                    document.body.className = "bg-black h-screen overflow-hidden";
                    document.getElementById('ui-threat').classList.remove('hidden');
                    document.getElementById('threat-text').innerText = data.content;
                } else {
                    document.getElementById('ui-standard').classList.remove('hidden');
                    document.getElementById('standard-text').innerText = data.content;
                }

            } catch(e) {
                document.getElementById('viewer-error').classList.remove('hidden');
                document.getElementById('error-msg').innerText = e.message;
            }
        }
    </script>
</body>
</html>
